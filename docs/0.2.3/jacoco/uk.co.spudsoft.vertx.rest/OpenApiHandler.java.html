<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd"><html xmlns="http://www.w3.org/1999/xhtml" lang="en"><head><meta http-equiv="Content-Type" content="text/html;charset=UTF-8"/><link rel="stylesheet" href="../jacoco-resources/report.css" type="text/css"/><link rel="shortcut icon" href="../jacoco-resources/report.gif" type="image/gif"/><title>OpenApiHandler.java</title><link rel="stylesheet" href="../jacoco-resources/prettify.css" type="text/css"/><script type="text/javascript" src="../jacoco-resources/prettify.js"></script></head><body onload="window['PR_TAB_WIDTH']=4;prettyPrint()"><div class="breadcrumb" id="breadcrumb"><span class="info"><a href="../jacoco-sessions.html" class="el_session">Sessions</a></span><a href="../index.html" class="el_report">Vertx RESTEasy Helpers</a> &gt; <a href="index.source.html" class="el_package">uk.co.spudsoft.vertx.rest</a> &gt; <span class="el_source">OpenApiHandler.java</span></div><h1>OpenApiHandler.java</h1><pre class="source lang-java linenums">/*
 * To change this license header, choose License Headers in Project Properties.
 * To change this template file, choose Tools | Templates
 * and open the template in the editor.
 */
package uk.co.spudsoft.vertx.rest;

import edu.umd.cs.findbugs.annotations.Nullable;
import static io.netty.handler.codec.http.HttpHeaderNames.CONTENT_SECURITY_POLICY;
import static io.netty.handler.codec.http.HttpHeaderNames.X_FRAME_OPTIONS;
import io.swagger.v3.core.filter.OpenAPISpecFilter;
import io.swagger.v3.core.filter.SpecFilter;
import io.swagger.v3.core.util.Json;
import io.swagger.v3.core.util.Json31;
import io.swagger.v3.core.util.Yaml;
import io.swagger.v3.core.util.Yaml31;
import io.swagger.v3.jaxrs2.integration.JaxrsOpenApiContextBuilder;
import io.swagger.v3.oas.integration.api.OpenAPIConfiguration;
import io.swagger.v3.oas.integration.api.OpenApiContext;
import io.swagger.v3.oas.models.OpenAPI;
import io.swagger.v3.oas.models.PathItem;
import io.swagger.v3.oas.models.Paths;
import io.swagger.v3.oas.models.media.Schema;
import io.vertx.core.Handler;
import io.vertx.core.MultiMap;
import io.vertx.core.buffer.Buffer;
import io.vertx.core.http.Cookie;
import io.vertx.core.http.HttpHeaders;
import io.vertx.core.http.HttpServerRequest;
import io.vertx.core.net.HostAndPort;
import io.vertx.ext.web.RoutingContext;
import jakarta.ws.rs.core.Application;
import jakarta.ws.rs.core.MediaType;
import java.nio.charset.StandardCharsets;
import java.util.ArrayList;
import java.util.HashMap;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.Objects;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;

/**
 * Vert.x web handler for outputting openapi definitions based on RestEasy Jax-RS endpoints.
 *
 * @author jtalbut
 */
public class OpenApiHandler implements Handler&lt;RoutingContext&gt; {

  @SuppressWarnings(&quot;constantname&quot;)
<span class="fc" id="L52">  private static final Logger logger = LoggerFactory.getLogger(OpenApiHandler.class);</span>

  /**
   * Request path that will return the description from the OpenAPI document as a standalone HTML document.
   */
  public static final String SCHEMA_DESCRIPTION = &quot;/schema/description/&quot;;
  
  private static final String DEFAULT_OPENAPI_EXPLORER_URL = &quot;https://unpkg.com/openapi-explorer@2.2.733/dist/browser/openapi-explorer.min.js&quot;;
  
  private final Application app;
  private final OpenAPIConfiguration openApiConfiguration;
  private String openApiContextId;
  private final String basePath;
  private final String openApiExplorerUrl;

  /**
   * Constructor.
   *
   * @param app The Jax-RS application, typically the Main class.
   * @param openApiConfiguration The Open API configuration, may be null.
   * @param basePath Base path to be prepended to any paths.
   * @param openApiExplorerUrl The URL to use to access Open API Explorer, to override the default value from DEFAULT_OPENAPI_EXPLORER_URL.
   * 
   */
  public OpenApiHandler(Application app, OpenAPIConfiguration openApiConfiguration, String basePath, @Nullable String openApiExplorerUrl) {
<span class="fc" id="L77">    this(app</span>
<span class="fc" id="L78">            , Objects.requireNonNull(openApiConfiguration, &quot;openApiConfiguration may not be null&quot;)</span>
<span class="fc" id="L79">            , Objects.requireNonNull(basePath, &quot;basePath may not be null&quot;)</span>
            , openApiExplorerUrl
            , true
    );
<span class="fc" id="L83">  }  </span>
  
  /**
   * Private constructor to avoid CT_CONSTRUCTOR_THROW.
   * 
   * To avoid CT_CONSTRUCTOR_THROW the public constructor must consist purely of a call to this constructor and
   * must perform all validation that may throw an exception.
   * A factory method could equally be used, as long as the actual constructor does not throw any exceptions.
   *
   * @param app The Jax-RS application, typically the Main class.
   * @param openApiConfiguration The Open API configuration, may be null.
   * @param basePath Base path to be prepended to any paths.
   * @param openApiExplorerUrl The URL to use to access Open API Explorer, to override the default value from DEFAULT_OPENAPI_EXPLORER_URL.
   * @param checked Unused argument that serves purely to distinguish from the public constructor.
   */
<span class="fc" id="L98">  private OpenApiHandler(Application app, OpenAPIConfiguration openApiConfiguration, String basePath, @Nullable String openApiExplorerUrl, boolean checked) {</span>
<span class="fc" id="L99">    this.app = app;</span>
<span class="fc" id="L100">    this.openApiConfiguration = openApiConfiguration;</span>
    
<span class="fc bfc" id="L102" title="All 2 branches covered.">    if (basePath.endsWith(&quot;/&quot;)) {</span>
<span class="fc" id="L103">      basePath = basePath.substring(0, basePath.length() - 1);</span>
    }
    
<span class="fc" id="L106">    this.basePath = basePath;</span>
    
<span class="pc bpc" id="L108" title="1 of 2 branches missed.">    if (openApiExplorerUrl == null) {</span>
<span class="fc" id="L109">      openApiExplorerUrl = DEFAULT_OPENAPI_EXPLORER_URL;</span>
    }
<span class="fc" id="L111">    this.openApiExplorerUrl = openApiExplorerUrl;</span>
<span class="fc" id="L112">  }</span>
  
  /**
   * UiHandler factory method.
   * @return a new UiHandler object.
   */
  public UiHandler getUiHandler() {
<span class="fc" id="L119">    return new UiHandler(openApiExplorerUrl);</span>
  }
  
  private static String hapToHost(HostAndPort hap, boolean isSsl) {
<span class="fc bfc" id="L123" title="All 2 branches covered.">    int nativePort = isSsl ? 443 : 80;</span>
<span class="pc bpc" id="L124" title="1 of 4 branches missed.">    if (hap.port() == nativePort || hap.port() &lt; 0) {</span>
<span class="fc" id="L125">      return hap.host();</span>
    } else {
<span class="fc" id="L127">      return hap.host() + &quot;:&quot; + hap.port();</span>
    }
  }
  
  /**
   * The Vertx handler for converting a request into an HTML page that uses 
   * &lt;a href=&quot;https://github.com/Rhosys/openapi-explorer&quot;&gt;OpenAPI-Explorer&lt;/a&gt; to reference /openapi.yaml.
   * 
   * The HTML page uses &lt;a href=&quot;https://www.unpkg.com/&quot;&gt;unpkg&lt;/a&gt; to reference 
   * &lt;a href=&quot;https://unpkg.com/openapi-explorer@0/dist/browser/openapi-explorer.min.js&quot;&gt;openapi-explorer.min.js&lt;/a&gt;.
   * 
   */
  public static class UiHandler implements Handler&lt;RoutingContext&gt; {
    
    private final String openApiExplorerUrl;

<span class="fc" id="L143">    public UiHandler(String openApiExplorerUrl) {</span>
<span class="fc" id="L144">      this.openApiExplorerUrl = openApiExplorerUrl;</span>
<span class="fc" id="L145">    }</span>
    
    static String buildPath(RoutingContext event) {
<span class="fc" id="L148">      HttpServerRequest request = event.request();      </span>
<span class="fc" id="L149">      MultiMap headers = request.headers();</span>
<span class="fc bfc" id="L150" title="All 2 branches covered.">      String proto = headers == null ? null : headers.get(&quot;X-Forwarded-Proto&quot;);</span>
<span class="fc" id="L151">      HostAndPort hap = request.authority();</span>
      String host;
<span class="fc bfc" id="L153" title="All 2 branches covered.">      if (proto == null) {</span>
<span class="fc bfc" id="L154" title="All 2 branches covered.">        if (request.isSSL()) {</span>
<span class="fc" id="L155">          proto = &quot;https://&quot;;</span>
<span class="fc" id="L156">          host = hapToHost(hap, true);</span>
        } else {
<span class="fc" id="L158">          proto = &quot;http://&quot;;</span>
<span class="fc" id="L159">          host = hapToHost(hap, false);</span>
        }
      } else {
<span class="fc" id="L162">        proto = proto + &quot;://&quot;;</span>
<span class="fc" id="L163">        host = hapToHost(hap, &quot;https&quot;.equals(proto));</span>
      }
      
<span class="fc" id="L166">      return proto</span>
              + host
              + &quot;/openapi.yaml&quot;
              ;
    }
    
    @Override
    public void handle(RoutingContext event) {

<span class="fc" id="L175">      String path = buildPath(event);</span>
      
<span class="fc" id="L177">      String html = &quot;&quot;&quot;</span>
                &lt;!doctype html&gt;
                &lt;html&gt;
                  &lt;head&gt;
                    &lt;script type=&quot;module&quot; src=&quot;EXPLORER_URL&quot;&gt;&lt;/script&gt;
                  &lt;/head&gt;
                  &lt;body&gt;
                    &lt;openapi-explorer spec-url=&quot;PATH&quot;&gt; &lt;/openapi-explorer&gt;
                  &lt;/body&gt;
                &lt;/html&gt;
                &quot;&quot;&quot;
<span class="fc" id="L188">              .replaceAll(&quot;EXPLORER_URL&quot;, openApiExplorerUrl)</span>
<span class="fc" id="L189">              .replaceAll(&quot;PATH&quot;, path);</span>
      
<span class="fc" id="L191">      event.response().headers()</span>
<span class="fc" id="L192">              .add(HttpHeaders.CONTENT_TYPE, &quot;text/html; charset=utf-8&quot;)</span>
<span class="fc" id="L193">              .add(X_FRAME_OPTIONS, &quot;SAMEORIGIN&quot;)</span>
              ;
              
<span class="fc" id="L196">      event.response()</span>
<span class="fc" id="L197">              .setStatusCode(200)</span>
<span class="fc" id="L198">              .end(Buffer.buffer(html.getBytes(StandardCharsets.UTF_8)));</span>
<span class="fc" id="L199">    }</span>
    
  }

  /**
   * The Java OpenAPI implementation caches the OpenID context per context ID. In live usage this is almost never an
   * issue because there is only one OpenAPI configuration required in a given service. However this completely breaks
   * unit tests, that want to use different configurations. For that purpose it is possible to set a context ID.
   *
   * @param openContextId The Open API context ID to use.
   * @return this for fluent usage.
   */
  public OpenApiHandler setOpenContextId(String openContextId) {
<span class="fc" id="L212">    this.openApiContextId = openContextId;</span>
<span class="fc" id="L213">    return this;</span>
  }
  
  @Override
  public void handle(RoutingContext event) {
<span class="fc" id="L218">    logger.trace(&quot;Handling OpenAPI request&quot;);</span>
    try {
<span class="fc" id="L220">      JaxrsOpenApiContextBuilder&lt;?&gt; oacb = new JaxrsOpenApiContextBuilder&lt;&gt;()</span>
<span class="fc" id="L221">              .application(app);</span>
<span class="fc" id="L222">      oacb.setOpenApiConfiguration(openApiConfiguration);</span>
<span class="fc bfc" id="L223" title="All 2 branches covered.">      if (openApiContextId != null) {</span>
<span class="fc" id="L224">        oacb.setCtxId(openApiContextId);</span>
      }
<span class="fc" id="L226">      OpenApiContext ctx = oacb.buildContext(true);</span>
      
<span class="fc" id="L228">      OpenAPIConfiguration config = ctx.getOpenApiConfiguration();      </span>
<span class="pc bpc" id="L229" title="1 of 2 branches missed.">      if (config == null) {</span>
<span class="nc" id="L230">        config = openApiConfiguration;</span>
      }
      
<span class="fc" id="L233">      boolean pretty = false;</span>
<span class="fc bfc" id="L234" title="All 2 branches covered.">      if (Boolean.TRUE.equals(config.isPrettyPrint())) {</span>
<span class="fc" id="L235">        pretty = true;</span>
      }

<span class="fc" id="L238">      OpenAPI oas = ctx.read();</span>
<span class="pc bpc" id="L239" title="1 of 2 branches missed.">      if (oas != null) {</span>
<span class="fc bfc" id="L240" title="All 2 branches covered.">        if (!basePath.isEmpty()) {</span>
<span class="fc" id="L241">          adjustPaths(oas);</span>
        }      
<span class="fc bfc" id="L243" title="All 2 branches covered.">        if (config.getFilterClass() != null) {</span>
          try {
<span class="fc" id="L245">            OpenAPISpecFilter filterImpl = (OpenAPISpecFilter) Class.forName(</span>
<span class="fc" id="L246">                    ctx.getOpenApiConfiguration().getFilterClass()).getDeclaredConstructor().newInstance();</span>
<span class="fc" id="L247">            SpecFilter f = new SpecFilter();</span>
<span class="fc" id="L248">            oas = f.filter(oas,</span>
                     filterImpl,
<span class="fc" id="L250">                     getQueryParams(event),</span>
<span class="fc" id="L251">                     getCookies(event),</span>
<span class="fc" id="L252">                     getHeaders(event)</span>
            );
<span class="nc" id="L254">          } catch (Exception e) {</span>
<span class="nc" id="L255">            logger.error(&quot;failed to load filter&quot;, e);</span>
<span class="fc" id="L256">          }</span>
        }
      }

<span class="pc bpc" id="L260" title="1 of 2 branches missed.">      if (oas == null) {</span>
<span class="nc" id="L261">        logger.error(&quot;Failed to create OpenAPI object&quot;);</span>
<span class="nc" id="L262">        event.fail(404);</span>
<span class="nc" id="L263">        return ;</span>
      }

<span class="fc" id="L266">      var response = event.response();</span>
<span class="fc" id="L267">      response.putHeader(&quot;Access-Control-Request-Method&quot;, &quot;GET&quot;);</span>
<span class="fc" id="L268">      response.putHeader(X_FRAME_OPTIONS, &quot;SAMEORIGIN&quot;);</span>
<span class="fc" id="L269">      response.putHeader(CONTENT_SECURITY_POLICY, &quot;default-src 'self'; img-src 'self'; style-src 'self' 'unsafe-hashes' 'unsafe-inline'; connect-src 'self'; script-src 'self' 'unsafe-eval' 'unsafe-inline' 'unsafe-eval'; manifest-src 'self'&quot;);</span>
      
<span class="fc" id="L271">      String normalizedPath = event.normalizedPath();</span>
<span class="fc" id="L272">      int startPos = normalizedPath.indexOf(SCHEMA_DESCRIPTION);</span>
<span class="fc bfc" id="L273" title="All 2 branches covered.">      if (startPos &gt; 0) {</span>
<span class="fc" id="L274">        String component = normalizedPath.substring(SCHEMA_DESCRIPTION.length() + startPos);</span>
<span class="fc" id="L275">        logger.debug(&quot;Component: {}&quot;, component);</span>
<span class="fc" id="L276">        Schema&lt;?&gt; schema = oas.getComponents().getSchemas().get(component);</span>
<span class="fc bfc" id="L277" title="All 2 branches covered.">        if (schema == null) {</span>
<span class="fc" id="L278">          logger.error(&quot;Component {} not found in schemas&quot;, component);</span>
<span class="fc" id="L279">          event.fail(404);</span>
<span class="fc" id="L280">          return ;</span>
        }
<span class="fc" id="L282">        String description = schema.getDescription();</span>
<span class="pc bpc" id="L283" title="2 of 4 branches missed.">        if (description != null &amp;&amp; !description.isEmpty()) {</span>
<span class="fc" id="L284">          response.putHeader(&quot;Content-Type&quot;, &quot;text/html&quot;);</span>
<span class="fc" id="L285">          response.end(&quot;&lt;html&gt;&lt;body&gt;&quot; + description + &quot;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
        } else {
<span class="nc" id="L287">          response.putHeader(&quot;Content-Type&quot;, &quot;text/html&quot;);</span>
<span class="nc" id="L288">          response.end(&quot;&lt;html&gt;&lt;body&gt;&lt;/body&gt;&lt;/html&gt;&quot;);</span>
        }
<span class="fc bfc" id="L290" title="All 2 branches covered.">      } else if (normalizedPath.endsWith(&quot;.yaml&quot;)) {</span>
<span class="fc" id="L291">        response.putHeader(&quot;Content-Type&quot;, &quot;application/yaml&quot;);</span>
<span class="fc bfc" id="L292" title="All 2 branches covered.">        if (config.isOpenAPI31()) {</span>
<span class="pc bpc" id="L293" title="1 of 2 branches missed.">          response.end(pretty ? Yaml31.pretty(oas) : Yaml31.mapper().writeValueAsString(oas));</span>
        } else {
<span class="fc bfc" id="L295" title="All 2 branches covered.">          response.end(pretty ? Yaml.pretty(oas) : Yaml.mapper().writeValueAsString(oas));</span>
        }
      } else {
<span class="fc" id="L298">        response.putHeader(&quot;Content-Type&quot;, MediaType.APPLICATION_JSON);</span>
<span class="pc bpc" id="L299" title="1 of 2 branches missed.">        if (config.isOpenAPI31()) {</span>
<span class="nc bnc" id="L300" title="All 2 branches missed.">          response.end(pretty ? Json31.pretty(oas) : Json31.mapper().writeValueAsString(oas));</span>
        } else {
<span class="fc bfc" id="L302" title="All 2 branches covered.">          response.end(pretty ? Json.pretty(oas) : Json.mapper().writeValueAsString(oas));</span>
        }
      }
<span class="nc" id="L305">    } catch (Throwable ex) {</span>
<span class="nc" id="L306">      logger.error(&quot;failed to generate {}: &quot;,</span>
<span class="nc bnc" id="L307" title="All 2 branches missed.">               event.normalizedPath().endsWith(&quot;.yaml&quot;) ? &quot;yaml&quot; : &quot;json&quot;,</span>
               ex);
<span class="nc" id="L309">      event.fail(500);</span>
<span class="fc" id="L310">    }</span>
<span class="fc" id="L311">  }</span>

  private void adjustPaths(OpenAPI oas) {
<span class="fc" id="L314">    Paths paths = oas.getPaths();    </span>
<span class="pc bpc" id="L315" title="1 of 4 branches missed.">    if ((paths != null) &amp;&amp; !paths.isEmpty()) {</span>
<span class="fc bfc" id="L316" title="All 2 branches covered.">      if (!paths.keySet().stream().findAny().orElse(&quot;&quot;).startsWith(basePath)) {</span>
<span class="fc" id="L317">        Paths newPaths = new Paths();</span>
<span class="fc" id="L318">        newPaths.setExtensions(paths.getExtensions());</span>
<span class="fc bfc" id="L319" title="All 2 branches covered.">        for (Entry&lt;String, PathItem&gt; entry : paths.entrySet()) {</span>
<span class="fc" id="L320">          newPaths.put(basePath + entry.getKey(), entry.getValue());</span>
<span class="fc" id="L321">        }</span>
<span class="fc" id="L322">        oas.setPaths(newPaths);</span>
      }
    }
<span class="fc" id="L325">  }</span>
  
  private Map&lt;String, List&lt;String&gt;&gt; getQueryParams(RoutingContext routingContext) {
<span class="fc" id="L328">    return multiMapToMap(routingContext.queryParams());</span>
  }

  private Map&lt;String, String&gt; getCookies(RoutingContext routingContext) {
<span class="fc" id="L332">    Map&lt;String, String&gt; result = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L333" title="All 2 branches covered.">    for (Cookie cookie : routingContext.request().cookies()) {</span>
<span class="fc" id="L334">      result.put(cookie.getName(), cookie.getValue());</span>
<span class="fc" id="L335">    }</span>
<span class="fc" id="L336">    return result;</span>
  }

  private Map&lt;String, List&lt;String&gt;&gt; getHeaders(RoutingContext routingContext) {
<span class="fc" id="L340">    return multiMapToMap(routingContext.request().headers());</span>
  }

  static Map&lt;String, List&lt;String&gt;&gt; multiMapToMap(MultiMap items) {
<span class="fc" id="L344">    Map&lt;String, List&lt;String&gt;&gt; result = new HashMap&lt;&gt;();</span>
<span class="fc bfc" id="L345" title="All 2 branches covered.">    if (items != null) {</span>
<span class="fc bfc" id="L346" title="All 2 branches covered.">      for (Entry&lt;String, String&gt; entry : items) {</span>
<span class="fc" id="L347">        List&lt;String&gt; list = result.get(entry.getKey());</span>
<span class="fc bfc" id="L348" title="All 2 branches covered.">        if (list == null) {</span>
<span class="fc" id="L349">          list = new ArrayList&lt;&gt;();</span>
<span class="fc" id="L350">          result.put(entry.getKey(), list);</span>
        }
<span class="fc" id="L352">        list.add(entry.getValue());</span>
<span class="fc" id="L353">      }</span>
    }
<span class="fc" id="L355">    return result;</span>
  }

}
</pre><div class="footer"><span class="right">Created with <a href="http://www.jacoco.org/jacoco">JaCoCo</a> 0.8.14.202510111229</span></div></body></html>